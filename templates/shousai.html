<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>対象者詳細・アセスメント</title>
  <!-- 統一CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/shousai.css') }}">
</head>
<body>
  <div class="page-wrapper">
    <header class="page-header">
      <h1>認知症初期集中支援　対象者詳細・アセスメント</h1>
      <div class="client-info-header">
        <label>利用者ID（client_id）：</label>
        <input type="text" id="global_client_id" class="client-id-input" placeholder="例: 1, 2, 3 ..." />
        <button type="button" id="reloadBtn">読込</button>
      </div>
    </header>

    <!-- タブ切り替え -->
    <nav class="tabs">
      <button class="tab-button active" data-tab="tab-client">① 利用者基本情報</button>
      <button class="tab-button" data-tab="tab-visit">② 訪問記録表</button>
      <button class="tab-button" data-tab="tab-physical">③ 身体状況チェック表</button>
      <button class="tab-button" data-tab="tab-dasc">④ DASC-21</button>
      <button class="tab-button" data-tab="tab-dbd">⑤ DBD-13</button>
      <button class="tab-button" data-tab="tab-files">⑥ 共有ファイル</button>
    </nav>

    <main class="tab-contents">

      <!-- ① 利用者基本情報（client） -->
      <section id="tab-client" class="tab-pane active">
        <h2>① 利用者基本情報（client）</h2>
        <form id="form-client" class="form-section">
          <!-- client_id は共通ID。ここにも持たせておく -->
          <input type="hidden" name="client_id" class="client-id-field" />

          <h3 class="sub-title">【基本情報】</h3>

          <div class="form-grid">
            <div class="form-item">
              <label>作成担当者（writer_name）</label>
              <input type="text" name="writer_name">
            </div>

            <div class="form-item">
              <label>相談日（consultation_date）</label>
              <input type="date" name="consultation_date">
            </div>

            <div class="form-item">
              <label>本人の現況（current_status）</label>
              <textarea name="current_status"></textarea>
            </div>

            <div class="form-item">
              <label>本人氏名（client_name）</label>
              <input type="text" name="client_name">
            </div>

            <div class="form-item">
              <label>性別（gender）</label>
              <select name="gender">
                <option value="">選択してください</option>
                <option value="男性">男性</option>
                <option value="女性">女性</option>
                <option value="その他">その他</option>
              </select>
            </div>

            <div class="form-item">
              <label>生年月日（birth_date）</label>
              <input type="date" name="birth_date">
            </div>

            <div class="form-item">
              <label>住所（address）</label>
              <input type="text" name="address">
            </div>

            <div class="form-item">
              <label>電話番号（phone_number）</label>
              <input type="text" name="phone_number">
            </div>

            <div class="form-item">
              <label>障害高齢者の日常生活自立度（disability_adl_level）</label>
              <input type="text" name="disability_adl_level" placeholder="自立 / J1 / A1 ...">
            </div>

            <div class="form-item">
              <label>認知症高齢者の日常生活自立度（dementia_adl_level）</label>
              <input type="text" name="dementia_adl_level" placeholder="自立 / IIa / IIIa ...">
            </div>

            <div class="form-item">
              <label>認定・総合事業情報（certification_info）</label>
              <textarea name="certification_info"></textarea>
            </div>

            <div class="form-item">
              <label>障害等認定（disability_certification）</label>
              <textarea name="disability_certification" placeholder="身障○級・療育○度 など"></textarea>
            </div>

            <div class="form-item">
              <label>住居環境（living_environment）</label>
              <textarea name="living_environment" placeholder="自宅 / 借家 / 集合住宅 など"></textarea>
            </div>

            <div class="form-item">
              <label>経済状況（economic_status）</label>
              <textarea name="economic_status" placeholder="年金・生活保護 等"></textarea>
            </div>

            <div class="form-item">
              <label>来所者・相談者氏名（visitor_name）</label>
              <input type="text" name="visitor_name">
            </div>

            <div class="form-item">
              <label>来所者連絡先（visitor_contact）</label>
              <input type="text" name="visitor_contact">
            </div>

            <div class="form-item">
              <label>本人との続柄（relation_to_client）</label>
              <input type="text" name="relation_to_client">
            </div>

            <div class="form-item">
              <label>家族構成（family_composition）</label>
              <textarea name="family_composition"></textarea>
            </div>

            <div class="form-item">
              <label>緊急連絡先氏名（emergency_contact_name）</label>
              <input type="text" name="emergency_contact_name">
            </div>
          </div>

          <h3 class="sub-title">【介護予防に関する事項】</h3>

          <div class="form-grid">
            <div class="form-item">
              <label>続柄（emergency_relation）</label>
              <input type="text" name="emergency_relation">
            </div>

            <div class="form-item">
              <label>緊急連絡先（emergency_contact_info）</label>
              <input type="text" name="emergency_contact_info">
            </div>

            <div class="form-item">
              <label>今までの生活歴（life_history）</label>
              <textarea name="life_history"></textarea>
            </div>

            <div class="form-item">
              <label>現在の生活状況・1日の過ごし方（daily_life_pattern）</label>
              <textarea name="daily_life_pattern"></textarea>
            </div>

            <div class="form-item">
              <label>時間帯（time_of_day）</label>
              <input type="text" name="time_of_day" placeholder="例：日中 / 夜間 など">
            </div>

            <div class="form-item">
              <label>本人の思い・気持ち（person_content）</label>
              <textarea name="person_content"></textarea>
            </div>

            <div class="form-item">
              <label>介護者・家族の思い（caregiver_content）</label>
              <textarea name="caregiver_content"></textarea>
            </div>

            <div class="form-item">
              <label>趣味・楽しみ（hobbies）</label>
              <textarea name="hobbies"></textarea>
            </div>

            <div class="form-item">
              <label>友人・地域とのつながり（social_connections）</label>
              <textarea name="social_connections"></textarea>
            </div>
          </div>

          <h3 class="sub-title">【現病歴・既往歴と経過】（新しいものから書く・現在の状況に関連するものは必ず書く）</h3>

          <div class="form-grid">
            <div class="form-item">
              <label>発症時期（disease_onset_date）</label>
              <input type="date" name="disease_onset_date">
            </div>

            <div class="form-item">
              <label>主な疾患名（disease_name）</label>
              <input type="text" name="disease_name">
            </div>

            <div class="form-item">
              <label>主治医・医療機関（medical_institution）</label>
              <input type="text" name="medical_institution">
            </div>

            <div class="form-item">
              <label>既往歴（medical_history）</label>
              <textarea name="medical_history"></textarea>
            </div>

            <div class="form-item">
              <label>現在の状態・経過（current_condition）</label>
              <textarea name="current_condition"></textarea>
            </div>
          </div>

          <h3 class="sub-title">【現在利用しているサービス】</h3>

          <div class="form-grid">
            <div class="form-item">
              <label>現在利用中の公的サービス（public_services）</label>
              <textarea name="public_services"></textarea>
            </div>

            <div class="form-item">
              <label>現在利用中の非公的サービス（private_services）</label>
              <textarea name="private_services"></textarea>
            </div>
          </div>

          <div class="form-actions right">
            <button type="button" class="btn-primary" onclick="saveClient()">保存</button>
          </div>
        </form>
      </section>

      <!-- ② 訪問記録表（visit_record） -->
      <section id="tab-visit" class="tab-pane">
        <h2>② 訪問記録表（visit_record）</h2>

        <form id="form-visit" class="form-section">
          <input type="hidden" name="client_id" class="client-id-field" />

          <div class="form-grid">
            <div class="form-item">
              <label>訪問日時（visit_datetime）</label>
              <input type="datetime-local" name="visit_datetime">
            </div>

            <div class="form-item">
              <label>訪問者氏名（visitor_name）</label>
              <input type="text" name="visitor_name">
            </div>

            <div class="form-item full">
              <label>訪問目的（visit_purpose）</label>
              <textarea name="visit_purpose" rows="2"></textarea>
            </div>
          </div>

          <h3 class="sub-title">【訪問時の観察項目】</h3>

          <div class="long-section">

            <div class="form-item full">
              <label>［訪問に対する本人の反応・理解］</label>
              <textarea name="vr_reaction"></textarea>
            </div>

            <div class="form-item">
              <label>［認知機能］</label>
              <textarea name="vr_cognition"></textarea>
            </div>

            <div class="form-item">
              <label>認知症日常生活自立度</label>
              <input type="text" name="vr_dementia_adl" placeholder="例：IIa / IIIa">
            </div>

            <div class="form-item full">
              <label>［精神症状・行動症状］</label>
              <textarea name="vr_behavior"></textarea>
            </div>

            <div class="form-item">
              <label>［身体状況］</label>
              <textarea name="vr_physical"></textarea>
            </div>

            <div class="form-item">
              <label>障害高齢者日常生活自立度</label>
              <input type="text" name="vr_disability_adl" placeholder="例：J1 / A1">
            </div>

            <div class="form-item full">
              <label>［生活状況］</label>
              <textarea name="vr_living"></textarea>
            </div>

            <div class="form-item full">
              <label>［アセスメントシート合計］</label>
              <div class="inline-inputs">
                <label>DASC-21：</label><input type="number" name="vr_dasc">
                <label>DBD13：</label><input type="number" name="vr_dbd">
                <label>J-ZBI_8：</label><input type="number" name="vr_jzbi">
              </div>
            </div>

            <div class="form-item full">
              <label>［本人の意向・希望］</label>
              <textarea name="vr_person_intent"></textarea>
            </div>

            <div class="form-item full">
              <label>［介護者の意向・希望］</label>
              <textarea name="vr_family_intent"></textarea>
            </div>

            <div class="form-item full">
              <label>［その他］</label>
              <textarea name="vr_other"></textarea>
            </div>

          </div>

          <h3 class="sub-title">【訪問時の詳細観察（身体状況チェック）】</h3>
          <p class="note">※身体状況チェック表の内容を要約して記録する欄です</p>

          <div class="long-section">
            <div class="form-item full">
              <label>運動機能・立ち上がり・歩行状況</label>
              <textarea name="vr_mobility"></textarea>
            </div>

            <div class="form-item full">
              <label>移動方法・日常的な移動範囲</label>
              <textarea name="vr_movement"></textarea>
            </div>

            <div class="form-item full">
              <label>意思疎通の状況</label>
              <textarea name="vr_communication"></textarea>
            </div>

            <div class="form-item full">
              <label>視力・聴力</label>
              <textarea name="vr_senses"></textarea>
            </div>

            <div class="form-item full">
              <label>入浴・衛生・清潔状況</label>
              <textarea name="vr_hygiene"></textarea>
            </div>

            <div class="form-item full">
              <label>栄養状態・食事状況</label>
              <textarea name="vr_nutrition"></textarea>
            </div>

            <div class="form-item full">
              <label>排泄状況（尿・便・失禁）</label>
              <textarea name="vr_excretion"></textarea>
            </div>

            <div class="form-item full">
              <label>睡眠状況（睡眠薬・生活リズム含む）</label>
              <textarea name="vr_sleep"></textarea>
            </div>

            <div class="form-item full">
              <label>居住環境の問題</label>
              <textarea name="vr_house"></textarea>
            </div>

            <div class="form-item full">
              <label>金銭管理の状況</label>
              <textarea name="vr_money"></textarea>
            </div>

            <div class="form-item full">
              <label>家族の介護力</label>
              <textarea name="vr_family_care"></textarea>
            </div>

            <div class="form-item full">
              <label>虐待の可能性</label>
              <textarea name="vr_abuse"></textarea>
            </div>

            <div class="form-item full">
              <label>見守りの状況</label>
              <textarea name="vr_watch"></textarea>
            </div>

            <div class="form-item full">
              <label>緊急時のSOS発信の可否</label>
              <textarea name="vr_sos"></textarea>
            </div>
          </div>

          <h3 class="sub-title">【判断・支援内容】</h3>
          <div class="form-item full">
            <label>判断・支援内容（support_decision）</label>
            <textarea name="support_decision" rows="4"></textarea>
          </div>

          <div class="form-item full">
            <label>今後の方針・支援計画（future_plan）</label>
            <textarea name="future_plan" rows="4"></textarea>
          </div>

          <div class="form-actions right">
            <button type="button" onclick="saveVisit()">保存</button>
          </div>
        </form>
      </section>

      <!-- ③ 身体状況チェック表（physical_status） -->
      <section id="tab-physical" class="tab-pane">
      <h2>③ 身体状況チェック表（physical_status）</h2>

      <form id="form-physical" class="form-section">
        <input type="hidden" name="client_id" class="client-id-field" />

        <div class="long-section">

          <div class="form-item full">
            <label>［立ち上がり・運動機能］</label>
            <textarea name="ps_mobility" placeholder="例：支えなしで立てる／支えが必要 など"></textarea>
          </div>

          <div class="form-item full">
            <label>［歩行状況・歩行レベル］</label>
            <textarea name="ps_walking" placeholder="室内：自立/介助　屋外：自立/介助　独歩/杖/歩行車/車いすなど"></textarea>
          </div>

          <div class="form-item full">
            <label>［移動方法・範囲］</label>
            <textarea name="ps_transport" placeholder="公共交通機関／タクシー／自家用車／自転車／徒歩など"></textarea>
          </div>

          <div class="form-item full">
            <label>［意思疎通］</label>
            <textarea name="ps_communication" placeholder="訪問者と意思疎通ができるか、指示の理解など"></textarea>
          </div>

          <div class="form-item full">
            <label>［日常の意思決定］</label>
            <textarea name="ps_decision" placeholder="できる／ややできる／できない など"></textarea>
          </div>

          <div class="form-item full">
            <label>［視力・聴力・補聴器の有無］</label>
            <textarea name="ps_senses" placeholder="目が見えにくい／耳が聞こえにくい／補聴器の使用など"></textarea>
          </div>

          <div class="form-item full">
            <label>［入浴・清潔保持］</label>
            <textarea name="ps_hygiene" placeholder="入浴頻度・シャワー・清拭・清潔状態など"></textarea>
          </div>

          <div class="form-item full">
            <label>［衣類・家屋の清潔さ］</label>
            <textarea name="ps_cleanliness"></textarea>
          </div>

          <div class="form-item full">
            <label>［栄養状態・体重・食事状況］</label>
            <textarea name="ps_nutrition"></textarea>
          </div>

          <div class="form-item full">
            <label>［過食／異食］</label>
            <textarea name="ps_eating_behavior"></textarea>
          </div>

          <div class="form-item full">
            <label>［食物を噛む・飲み込む能力］</label>
            <textarea name="ps_swallowing"></textarea>
          </div>

          <div class="form-item full">
            <label>［食事拒否・時間］</label>
            <textarea name="ps_meal_refusal"></textarea>
          </div>

          <div class="form-item full">
            <label>［水分摂取状況］</label>
            <textarea name="ps_water"></textarea>
          </div>

          <div class="form-item full">
            <label>［飲酒・喫煙］</label>
            <textarea name="ps_habits"></textarea>
          </div>

          <div class="form-item full">
            <label>［排尿・排便］</label>
            <textarea name="ps_excretion"></textarea>
          </div>

          <div class="form-item full">
            <label>［便秘（下剤の使用）］</label>
            <textarea name="ps_constipation"></textarea>
          </div>

          <div class="form-item full">
            <label>［睡眠状況（睡眠薬の有無）］</label>
            <textarea name="ps_sleep"></textarea>
          </div>

          <div class="form-item full">
            <label>［起床・就寝時間］</label>
            <textarea name="ps_daily_rhythm"></textarea>
          </div>

          <div class="form-item full">
            <label>［日中の睡眠］</label>
            <textarea name="ps_daytime_sleep"></textarea>
          </div>

          <div class="form-item full">
            <label>［夜間の行動（大声・起き上がり）］</label>
            <textarea name="ps_night_behavior"></textarea>
          </div>

          <div class="form-item full">
            <label>［居住環境の問題］</label>
            <textarea name="ps_house_env"></textarea>
          </div>

          <div class="form-item full">
            <label>［金銭管理］</label>
            <textarea name="ps_money"></textarea>
          </div>

          <div class="form-item full">
            <label>［家族の介護力］</label>
            <textarea name="ps_family_care"></textarea>
          </div>

          <div class="form-item full">
            <label>［虐待の可能性］</label>
            <textarea name="ps_abuse"></textarea>
          </div>

          <div class="form-item full">
            <label>［見守りの状況］</label>
            <textarea name="ps_watch"></textarea>
          </div>

          <div class="form-item full">
            <label>［緊急時のSOS発信］</label>
            <textarea name="ps_sos"></textarea>
          </div>
        </div>

        <div class="form-actions right">
          <button type="button" onclick="savePhysical()">保存</button>
        </div>
      </form>
    </section>


      <!-- ④ DASC-21 -->
      <section id="tab-dasc" class="tab-pane">
        <h2>④ DASC-21（dasc21）</h2>

        <form id="form-dasc" class="form-section">
          <input type="hidden" name="client_id" class="client-id-field" />

          <div class="form-grid">
            <div class="form-item">
              <label>情報提供者氏名（informant_name）</label>
              <input type="text" name="informant_name">
            </div>

            <div class="form-item">
              <label>評価者氏名（evaluator_name）</label>
              <input type="text" name="evaluator_name">
            </div>
          </div>

          <h3>DASC-21 評価項目（0〜4）</h3>

          <div class="dasc-table">
            <!-- ここから21項目 -->
            <!-- 1～21項目ループ -->
            <!-- 各項目は q1 ～ q21 として保存 -->
            <table>
              <thead>
                <tr>
                  <th style="width:45%;">評価項目</th>
                  <th>0</th>
                  <th>1</th>
                  <th>2</th>
                  <th>3</th>
                  <th>4</th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td>1. 物忘れの程度</td>
                  <td><input type="radio" name="q1" value="0"></td>
                  <td><input type="radio" name="q1" value="1"></td>
                  <td><input type="radio" name="q1" value="2"></td>
                  <td><input type="radio" name="q1" value="3"></td>
                  <td><input type="radio" name="q1" value="4"></td>
                </tr>

                <tr>
                  <td>2. 同じことを繰り返す</td>
                  <td><input type="radio" name="q2" value="0"></td>
                  <td><input type="radio" name="q2" value="1"></td>
                  <td><input type="radio" name="q2" value="2"></td>
                  <td><input type="radio" name="q2" value="3"></td>
                  <td><input type="radio" name="q2" value="4"></td>
                </tr>

                <tr>
                  <td>3. 置き忘れ</td>
                  <td><input type="radio" name="q3" value="0"></td>
                  <td><input type="radio" name="q3" value="1"></td>
                  <td><input type="radio" name="q3" value="2"></td>
                  <td><input type="radio" name="q3" value="3"></td>
                  <td><input type="radio" name="q3" value="4"></td>
                </tr>

                <tr>
                  <td>4. 日付の理解</td>
                  <td><input type="radio" name="q4" value="0"></td>
                  <td><input type="radio" name="q4" value="1"></td>
                  <td><input type="radio" name="q4" value="2"></td>
                  <td><input type="radio" name="q4" value="3"></td>
                  <td><input type="radio" name="q4" value="4"></td>
                </tr>

                <tr>
                  <td>5. 場所の理解</td>
                  <td><input type="radio" name="q5" value="0"></td>
                  <td><input type="radio" name="q5" value="1"></td>
                  <td><input type="radio" name="q5" value="2"></td>
                  <td><input type="radio" name="q5" value="3"></td>
                  <td><input type="radio" name="q5" value="4"></td>
                </tr>

                <tr>
                  <td>6. 人物の理解</td>
                  <td><input type="radio" name="q6" value="0"></td>
                  <td><input type="radio" name="q6" value="1"></td>
                  <td><input type="radio" name="q6" value="2"></td>
                  <td><input type="radio" name="q6" value="3"></td>
                  <td><input type="radio" name="q6" value="4"></td>
                </tr>

                <tr>
                  <td>7. 服薬の管理</td>
                  <td><input type="radio" name="q7" value="0"></td>
                  <td><input type="radio" name="q7" value="1"></td>
                  <td><input type="radio" name="q7" value="2"></td>
                  <td><input type="radio" name="q7" value="3"></td>
                  <td><input type="radio" name="q7" value="4"></td>
                </tr>

                <tr>
                  <td>8. 金銭管理</td>
                  <td><input type="radio" name="q8" value="0"></td>
                  <td><input type="radio" name="q8" value="1"></td>
                  <td><input type="radio" name="q8" value="2"></td>
                  <td><input type="radio" name="q8" value="3"></td>
                  <td><input type="radio" name="q8" value="4"></td>
                </tr>

                <tr>
                  <td>9. 火の始末</td>
                  <td><input type="radio" name="q9" value="0"></td>
                  <td><input type="radio" name="q9" value="1"></td>
                  <td><input type="radio" name="q9" value="2"></td>
                  <td><input type="radio" name="q9" value="3"></td>
                  <td><input type="radio" name="q9" value="4"></td>
                </tr>

                <tr>
                  <td>10. 自動車・交通機関の利用</td>
                  <td><input type="radio" name="q10" value="0"></td>
                  <td><input type="radio" name="q10" value="1"></td>
                  <td><input type="radio" name="q10" value="2"></td>
                  <td><input type="radio" name="q10" value="3"></td>
                  <td><input type="radio" name="q10" value="4"></td>
                </tr>

                <tr>
                  <td>11. 食事の準備</td>
                  <td><input type="radio" name="q11" value="0"></td>
                  <td><input type="radio" name="q11" value="1"></td>
                  <td><input type="radio" name="q11" value="2"></td>
                  <td><input type="radio" name="q11" value="3"></td>
                  <td><input type="radio" name="q11" value="4"></td>
                </tr>

                <tr>
                  <td>12. 配膳・片付け</td>
                  <td><input type="radio" name="q12" value="0"></td>
                  <td><input type="radio" name="q12" value="1"></td>
                  <td><input type="radio" name="q12" value="2"></td>
                  <td><input type="radio" name="q12" value="3"></td>
                  <td><input type="radio" name="q12" value="4"></td>
                </tr>

                <tr>
                  <td>13. 洗濯</td>
                  <td><input type="radio" name="q13" value="0"></td>
                  <td><input type="radio" name="q13" value="1"></td>
                  <td><input type="radio" name="q13" value="2"></td>
                  <td><input type="radio" name="q13" value="3"></td>
                  <td><input type="radio" name="q13" value="4"></td>
                </tr>

                <tr>
                  <td>14. 掃除</td>
                  <td><input type="radio" name="q14" value="0"></td>
                  <td><input type="radio" name="q14" value="1"></td>
                  <td><input type="radio" name="q14" value="2"></td>
                  <td><input type="radio" name="q14" value="3"></td>
                  <td><input type="radio" name="q14" value="4"></td>
                </tr>

                <tr>
                  <td>15. 自分の身のまわりの管理</td>
                  <td><input type="radio" name="q15" value="0"></td>
                  <td><input type="radio" name="q15" value="1"></td>
                  <td><input type="radio" name="q15" value="2"></td>
                  <td><input type="radio" name="q15" value="3"></td>
                  <td><input type="radio" name="q15" value="4"></td>
                </tr>

                <tr>
                  <td>16. 服の着替え</td>
                  <td><input type="radio" name="q16" value="0"></td>
                  <td><input type="radio" name="q16" value="1"></td>
                  <td><input type="radio" name="q16" value="2"></td>
                  <td><input type="radio" name="q16" value="3"></td>
                  <td><input type="radio" name="q16" value="4"></td>
                </tr>

                <tr>
                  <td>17. 身だしなみ</td>
                  <td><input type="radio" name="q17" value="0"></td>
                  <td><input type="radio" name="q17" value="1"></td>
                  <td><input type="radio" name="q17" value="2"></td>
                  <td><input type="radio" name="q17" value="3"></td>
                  <td><input type="radio" name="q17" value="4"></td>
                </tr>

                <tr>
                  <td>18. 入浴</td>
                  <td><input type="radio" name="q18" value="0"></td>
                  <td><input type="radio" name="q18" value="1"></td>
                  <td><input type="radio" name="q18" value="2"></td>
                  <td><input type="radio" name="q18" value="3"></td>
                  <td><input type="radio" name="q18" value="4"></td>
                </tr>

                <tr>
                  <td>19. 排泄</td>
                  <td><input type="radio" name="q19" value="0"></td>
                  <td><input type="radio" name="q19" value="1"></td>
                  <td><input type="radio" name="q19" value="2"></td>
                  <td><input type="radio" name="q19" value="3"></td>
                  <td><input type="radio" name="q19" value="4"></td>
                </tr>

                <tr>
                  <td>20. 歩行</td>
                  <td><input type="radio" name="q20" value="0"></td>
                  <td><input type="radio" name="q20" value="1"></td>
                  <td><input type="radio" name="q20" value="2"></td>
                  <td><input type="radio" name="q20" value="3"></td>
                  <td><input type="radio" name="q20" value="4"></td>
                </tr>

                <tr>
                  <td>21. 外出</td>
                  <td><input type="radio" name="q21" value="0"></td>
                  <td><input type="radio" name="q21" value="1"></td>
                  <td><input type="radio" name="q21" value="2"></td>
                  <td><input type="radio" name="q21" value="3"></td>
                  <td><input type="radio" name="q21" value="4"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="form-grid">
            <div class="form-item">
              <label>備考（remarks）</label>
              <textarea name="remarks"></textarea>
            </div>

            <div class="form-item">
              <label>合計点（total_score）</label>
              <input type="number" name="total_score" id="dasc-total" readonly>
            </div>
          </div>

          <div class="form-actions right">
            <button type="button" onclick="saveDasc()">保存</button>
          </div>
        </form>
      </section>

      <!-- ⑤ DBD-13 -->
      <section id="tab-dbd" class="tab-pane">
        <h2>⑤ DBD-13（dbd13）</h2>

        <form id="form-dbd" class="form-section">
          <input type="hidden" name="client_id" class="client-id-field" />

          <div class="form-grid">
            <div class="form-item">
              <label>回答者氏名（respondent_name）</label>
              <input type="text" name="respondent_name">
            </div>

            <div class="form-item">
              <label>評価者氏名（evaluator_name）</label>
              <input type="text" name="evaluator_name">
            </div>

            <div class="form-item">
              <label>記入日（entry_date）</label>
              <input type="date" name="entry_date">
            </div>
          </div>

          <h3>DBD-13 評価項目（0〜4：問題なし → 重い）</h3>

          <table class="dbd-table">
            <thead>
              <tr>
                <th style="width: 50%;">項目</th>
                <th>0</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
              </tr>
            </thead>

            <tbody>
              <!-- 13項目（国立長寿医療研究センター・正式） -->
              <tr><td>1. もの盗られ妄想</td>
                <td><input type="radio" name="d1" value="0"></td>
                <td><input type="radio" name="d1" value="1"></td>
                <td><input type="radio" name="d1" value="2"></td>
                <td><input type="radio" name="d1" value="3"></td>
                <td><input type="radio" name="d1" value="4"></td>
              </tr>

              <tr><td>2. 不安・イライラ</td>
                <td><input type="radio" name="d2" value="0"></td>
                <td><input type="radio" name="d2" value="1"></td>
                <td><input type="radio" name="d2" value="2"></td>
                <td><input type="radio" name="d2" value="3"></td>
                <td><input type="radio" name="d2" value="4"></td>
              </tr>

              <tr><td>3. 不眠・睡眠リズムの乱れ</td>
                <td><input type="radio" name="d3" value="0"></td>
                <td><input type="radio" name="d3" value="1"></td>
                <td><input type="radio" name="d3" value="2"></td>
                <td><input type="radio" name="d3" value="3"></td>
                <td><input type="radio" name="d3" value="4"></td>
              </tr>

              <tr><td>4. 拒否・怒りやすい</td>
                <td><input type="radio" name="d4" value="0"></td>
                <td><input type="radio" name="d4" value="1"></td>
                <td><input type="radio" name="d4" value="2"></td>
                <td><input type="radio" name="d4" value="3"></td>
                <td><input type="radio" name="d4" value="4"></td>
              </tr>

              <tr><td>5. 徘徊</td>
                <td><input type="radio" name="d5" value="0"></td>
                <td><input type="radio" name="d5" value="1"></td>
                <td><input type="radio" name="d5" value="2"></td>
                <td><input type="radio" name="d5" value="3"></td>
                <td><input type="radio" name="d5" value="4"></td>
              </tr>

              <tr><td>6. 介護への抵抗</td>
                <td><input type="radio" name="d6" value="0"></td>
                <td><input type="radio" name="d6" value="1"></td>
                <td><input type="radio" name="d6" value="2"></td>
                <td><input type="radio" name="d6" value="3"></td>
                <td><input type="radio" name="d6" value="4"></td>
              </tr>

              <tr><td>7. 落ち着きのなさ・そわそわ</td>
                <td><input type="radio" name="d7" value="0"></td>
                <td><input type="radio" name="d7" value="1"></td>
                <td><input type="radio" name="d7" value="2"></td>
                <td><input type="radio" name="d7" value="3"></td>
                <td><input type="radio" name="d7" value="4"></td>
              </tr>

              <tr><td>8. 抑うつ気分</td>
                <td><input type="radio" name="d8" value="0"></td>
                <td><input type="radio" name="d8" value="1"></td>
                <td><input type="radio" name="d8" value="2"></td>
                <td><input type="radio" name="d8" value="3"></td>
                <td><input type="radio" name="d8" value="4"></td>
              </tr>

              <tr><td>9. 大声を出す・叫ぶ</td>
                <td><input type="radio" name="d9" value="0"></td>
                <td><input type="radio" name="d9" value="1"></td>
                <td><input type="radio" name="d9" value="2"></td>
                <td><input type="radio" name="d9" value="3"></td>
                <td><input type="radio" name="d9" value="4"></td>
              </tr>

              <tr><td>10. 暴力・攻撃性</td>
                <td><input type="radio" name="d10" value="0"></td>
                <td><input type="radio" name="d10" value="1"></td>
                <td><input type="radio" name="d10" value="2"></td>
                <td><input type="radio" name="d10" value="3"></td>
                <td><input type="radio" name="d10" value="4"></td>
              </tr>

              <tr><td>11. 幻覚</td>
                <td><input type="radio" name="d11" value="0"></td>
                <td><input type="radio" name="d11" value="1"></td>
                <td><input type="radio" name="d11" value="2"></td>
                <td><input type="radio" name="d11" value="3"></td>
                <td><input type="radio" name="d11" value="4"></td>
              </tr>

              <tr><td>12. 性的問題行動</td>
                <td><input type="radio" name="d12" value="0"></td>
                <td><input type="radio" name="d12" value="1"></td>
                <td><input type="radio" name="d12" value="2"></td>
                <td><input type="radio" name="d12" value="3"></td>
                <td><input type="radio" name="d12" value="4"></td>
              </tr>

              <tr><td>13. 異食・不適切な食行動</td>
                <td><input type="radio" name="d13" value="0"></td>
                <td><input type="radio" name="d13" value="1"></td>
                <td><input type="radio" name="d13" value="2"></td>
                <td><input type="radio" name="d13" value="3"></td>
                <td><input type="radio" name="d13" value="4"></td>
              </tr>

            </tbody>
          </table>

          <div class="form-item">
            <label>小計（subtotal_score）※項目1〜13の合計</label>
            <input type="number" name="subtotal_score" id="dbd_subtotal" readonly>
          </div>

          <div class="form-item">
            <label>合計点（total_score）※DBD-13 の総合点</label>
            <input type="number" name="total_score" id="dbd_total" readonly>
          </div>

          <div class="form-actions right">
            <button type="button" onclick="saveDbd()">保存</button>
          </div>
        </form>

      </section>
      <section id="tab-files" class="tab-pane">
        <h2>⑥ 共有ファイル（shared_folder）</h2>

        <div class="form-section">

          <div>
            <label>ファイルを選択：</label>
            <input type="file" id="upload_file_input">
            <button type="button" onclick="uploadFile()">アップロード</button>
          </div>

          <hr>

          <h3>この利用者のファイル一覧</h3>
          <div id="file_list"></div>

        </div>
      </section>

    </main>
  </div>

  <script>
    // -----------------------------
    // タブ切り替え
    // -----------------------------
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById(target).classList.add("active");

        // タブ状態をローカルに保存
        localStorage.setItem("shousai_active_tab", target);
      });
    });

    // -----------------------------
    // URL から client_id を取得
    // -----------------------------
    function getClientIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("client_id") || "";
    }

    // -----------------------------
    // client_id の同期
    // -----------------------------
    function syncClientIdFields(cid) {
      document.getElementById("global_client_id").value = cid;
      document.querySelectorAll(".client-id-field").forEach(el => {
        el.value = cid;
      });
    }

    // -----------------------------
    // フォーム → JSON 変換
    // -----------------------------
    function formToJSON(form) {
      const fd = new FormData(form);
      const obj = {};
      fd.forEach((value, key) => {
        if (key in obj) {
          if (!Array.isArray(obj[key])) {
            obj[key] = [obj[key]];
          }
          obj[key].push(value);
        } else {
          obj[key] = value;
        }
      });
      return obj;
    }

    // -----------------------------
    // JSON → フォームへ反映
    // -----------------------------
    function fillForm(formId, record) {
      if (!record) return;
      const form = document.getElementById(formId);
      if (!form) return;

      Object.keys(record).forEach(key => {
        const field = form.elements.namedItem(key);
        if (!field) return;

        if (field.type === "checkbox" || field.type === "radio") {
          // 今回は text/textarea/number中心なので簡易対応
          field.checked = !!record[key];
        } else {
          field.value = record[key] == null ? "" : record[key];
        }
      });
    }

    // -----------------------------
    // 共通 POST 関数
    // -----------------------------
    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (!res.ok || json.status !== "saved") {
        console.error(json);
        alert("保存中にエラーが発生しました：" + (json.message || res.statusText));
        return;
      }
      alert("保存しました");
    }

    // =============================
    // 保存ボタン：各フォーム
    // =============================
    function saveClient() {
      const cid = document.getElementById("global_client_id").value.trim();
      if (!cid) {
        alert("先に 利用者ID（client_id） を入力してください。");
        return;
      }
      syncClientIdFields(cid);
      const data = formToJSON(document.getElementById("form-client"));
      postJSON("/api/save_client", data);
    }

    function saveVisit() {
      const cid = document.getElementById("global_client_id").value.trim();
      if (!cid) {
        alert("先に 利用者ID（client_id） を入力してください。");
        return;
      }
      syncClientIdFields(cid);
      const data = formToJSON(document.getElementById("form-visit"));
      postJSON("/api/save_visit_record", data);
    }

    function savePhysical() {
      const cid = document.getElementById("global_client_id").value.trim();
      if (!cid) {
        alert("先に 利用者ID（client_id） を入力してください。");
        return;
      }
      syncClientIdFields(cid);
      const data = formToJSON(document.getElementById("form-physical"));
      postJSON("/api/save_physical_status", data);
    }

    function saveDasc() {
      const cid = document.getElementById("global_client_id").value.trim();
      if (!cid) {
        alert("先に 利用者ID（client_id） を入力してください。");
        return;
      }
      syncClientIdFields(cid);
      const data = formToJSON(document.getElementById("form-dasc"));
      postJSON("/api/save_dasc21", data);
    }

    function saveDbd() {
      const cid = document.getElementById("global_client_id").value.trim();
      if (!cid) {
        alert("先に 利用者ID（client_id） を入力してください。");
        return;
      }
      syncClientIdFields(cid);
      const data = formToJSON(document.getElementById("form-dbd"));
      postJSON("/api/save_dbd13", data);
    }

    // -----------------------------
    // DASC-21：合計点の自動計算
    // -----------------------------
    function calcDascTotal() {
      let total = 0;
      for (let i = 1; i <= 21; i++) {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (selected) {
          total += parseInt(selected.value);
        }
      }
      document.getElementById("dasc_total").value = total;
    }

    // -----------------------------
    // DBD-13 合計計算
    // -----------------------------
    function calcDbdTotal() {
      let subtotal = 0;

      for (let i = 1; i <= 13; i++) {
        const checked = document.querySelector(`input[name="d${i}"]:checked`);
        if (checked) subtotal += parseInt(checked.value);
      }

      document.getElementById("dbd_subtotal").value = subtotal;
      document.getElementById("dbd_total").value = subtotal; // 今回は subtotal＝total
    }

    // ラジオ変更時にリアルタイム計算
    for (let i = 1; i <= 13; i++) {
      document.querySelectorAll(`input[name="d${i}"]`).forEach(radio => {
        radio.addEventListener("change", calcDbdTotal);
      });
    }

    // ラジオボタン変更時に合計更新
    for (let i = 1; i <= 21; i++) {
      document.querySelectorAll(`input[name="q${i}"]`).forEach(r => {
        r.addEventListener("change", calcDascTotal);
      });
    }

    // -----------------------------
    // 全データ読み込み
    // -----------------------------
    async function loadAllData() {
      const cid = document.getElementById("global_client_id").value.trim();
      if (!cid) return;

      syncClientIdFields(cid);

      try {
        const res = await fetch(`/api/get_all_data?client_id=${encodeURIComponent(cid)}`);
        const json = await res.json();
        if (json.status !== "ok") {
          console.warn(json);
          return;
        }
        fillForm("form-client", json.client);
        fillForm("form-visit", json.visit_record);
        if (json.physical_status) {
          fillForm("form-physical", json.physical_status);
        }
        fillForm("form-dasc", json.dasc21);
        fillForm("form-dbd", json.dbd13);
      } catch (e) {
        console.error(e);
      }
    }
      async function loadFiles() {
        const cid = document.getElementById("global_client_id").value.trim();
        if (!cid) return;

        const res = await fetch(`/api/files?client_id=${cid}`);
        const json = await res.json();

        const box = document.getElementById("file_list");
        box.innerHTML = "";

        json.files.forEach(f => {
          const url = `/uploads/${f.file_path}`;
          box.innerHTML += `
            <div class="file-item">
              <a href="${url}" download>${f.file_path.split("/").pop()}</a>
              （${f.uploaded_at}）
              <button onclick="deleteFile(${f.folder_id})">削除</button>
            </div>
          `;
        });
      }

      async function uploadFile() {
        const cid = document.getElementById("global_client_id").value.trim();
        const file = document.getElementById("upload_file_input").files[0];

        if (!cid || !file) {
          alert("client_id とファイルを指定してください");
          return;
        }

        const fd = new FormData();
        fd.append("client_id", cid);
        fd.append("file", file);

        const res = await fetch("/api/upload_file", {
          method: "POST",
          body: fd
        });
        const json = await res.json();
        alert("保存しました");

        loadFiles();
      }

      async function deleteFile(folder_id) {
        const res = await fetch("/api/delete_file", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({folder_id})
        });

        const json = await res.json();
        alert("削除しました");
        loadFiles();
      }

    // -----------------------------
    // 初期設定
    // -----------------------------
    document.addEventListener("DOMContentLoaded", () => {
      // URLから client_id
      const cid = getClientIdFromUrl();
      if (cid) {
        syncClientIdFields(cid);
      }

      // 前回のタブ復元
      const savedTab = localStorage.getItem("shousai_active_tab");
      if (savedTab && document.getElementById(savedTab)) {
        document.querySelectorAll(".tab-button").forEach(b => {
          b.classList.toggle("active", b.dataset.tab === savedTab);
        });
        document.querySelectorAll(".tab-pane").forEach(p => {
          p.classList.toggle("active", p.id === savedTab);
        });
      }

      // 初期データ読み込み
      loadAllData();

      // 「読込」ボタンで再読込
      document.getElementById("reloadBtn").addEventListener("click", loadAllData);
      document.getElementById("reloadBtn").addEventListener("click", () => {
        loadAllData();
        loadFiles();
      });

    });
  </script>
</body>
</html>
